<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .config-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        .data-section {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .editable {
            background-color: #fff3cd;
            cursor: text;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>מנהל מסד נתונים - Google Sheets</h1>
        
        <div class="config-section">
            <h3>הגדרות חיבור</h3>
            <div class="form-group">
                <label>API Key של Google:</label>
                <input type="text" id="apiKey" placeholder="הכנס את ה-API Key שלך" style="width: 300px;">
            </div>
            <div class="form-group">
                <label>מזהה הגיליון (Spreadsheet ID):</label>
                <input type="text" id="spreadsheetId" placeholder="מזהה הגיליון מה-URL" style="width: 400px;">
            </div>
            <div class="form-group">
                <label>שם הגיליון:</label>
                <input type="text" id="sheetName" placeholder="Sheet1" value="Sheet1">
            </div>
            <button onclick="connectToSheet()">התחבר לגיליון</button>
        </div>

        <div class="status" id="status"></div>

        <div class="data-section">
            <h3>נתונים</h3>
            <button onclick="loadData()" style="background: #2196F3;">טען נתונים</button>
            <button onclick="showAddForm()" style="background: #FF9800;">הוסף רשומה חדשה</button>
            
            <div class="add-form" id="addForm" style="display: none;">
                <h4>הוספת רשומה חדשה</h4>
                <div id="newRowInputs"></div>
                <button onclick="addNewRow()">הוסף</button>
                <button onclick="hideAddForm()" style="background: #f44336;">ביטול</button>
            </div>

            <div id="dataContainer"></div>
        </div>
    </div>

    <script>
        let gapi_loaded = false;
        let currentData = [];
        let headers = [];

        // טעינת Google API
        function loadGoogleAPI() {
            if (!gapi_loaded) {
                gapi.load('client', initializeGapi);
            }
        }

        function initializeGapi() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showStatus('אנא הכנס API Key', 'error');
                return;
            }

            gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            }).then(() => {
                gapi_loaded = true;
                showStatus('חיבור ל-Google API הושלם בהצלחה', 'success');
            }).catch(error => {
                showStatus('שגיאה בחיבור ל-Google API: ' + error.message, 'error');
            });
        }

        function connectToSheet() {
            loadGoogleAPI();
        }

        function loadData() {
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const sheetName = document.getElementById('sheetName').value;

            if (!spreadsheetId || !gapi_loaded) {
                showStatus('אנא וודא שהתחברת תחילה', 'error');
                return;
            }

            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!A:Z'
            }).then(response => {
                const values = response.result.values;
                if (values && values.length > 0) {
                    headers = values[0];
                    currentData = values.slice(1);
                    displayData();
                    setupAddForm();
                    showStatus('נתונים נטענו בהצלחה', 'success');
                } else {
                    showStatus('לא נמצאו נתונים בגיליון', 'error');
                }
            }).catch(error => {
                showStatus('שגיאה בטעינת נתונים: ' + error.message, 'error');
            });
        }

        function displayData() {
            const container = document.getElementById('dataContainer');
            let html = '<table><thead><tr>';
            
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '<th>פעולות</th></tr></thead><tbody>';

            currentData.forEach((row, index) => {
                html += '<tr>';
                headers.forEach((header, colIndex) => {
                    const cellValue = row[colIndex] || '';
                    html += `<td class="editable" ondblclick="editCell(${index}, ${colIndex}, this)">${cellValue}</td>`;
                });
                html += `<td><button onclick="deleteRow(${index})" style="background: #f44336; padding: 5px 10px;">מחק</button></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function editCell(rowIndex, colIndex, element) {
            const currentValue = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.style.width = '100%';
            input.style.border = 'none';
            input.style.padding = '5px';

            input.onblur = function() {
                updateCell(rowIndex, colIndex, input.value, element);
            };

            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    updateCell(rowIndex, colIndex, input.value, element);
                }
            };

            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
        }

        function updateCell(rowIndex, colIndex, newValue, element) {
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const sheetName = document.getElementById('sheetName').value;
            
            // עדכון המערך המקומי
            if (!currentData[rowIndex]) {
                currentData[rowIndex] = [];
            }
            currentData[rowIndex][colIndex] = newValue;

            // חישוב כתובת התא
            const columnLetter = String.fromCharCode(65 + colIndex);
            const cellAddress = `${sheetName}!${columnLetter}${rowIndex + 2}`;

            // עדכון ב-Google Sheets
            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: spreadsheetId,
                range: cellAddress,
                valueInputOption: 'RAW',
                resource: {
                    values: [[newValue]]
                }
            }).then(() => {
                element.textContent = newValue;
                showStatus('התא עודכן בהצלחה', 'success');
            }).catch(error => {
                showStatus('שגיאה בעדכון התא: ' + error.message, 'error');
                element.textContent = currentData[rowIndex][colIndex] || '';
            });
        }

        function setupAddForm() {
            const container = document.getElementById('newRowInputs');
            let html = '';
            headers.forEach((header, index) => {
                html += `
                    <div class="form-group">
                        <label>${header}:</label>
                        <input type="text" id="newInput${index}" placeholder="הכנס ${header}">
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
        }

        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
        }

        function addNewRow() {
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const sheetName = document.getElementById('sheetName').value;
            
            const newRow = [];
            headers.forEach((header, index) => {
                const input = document.getElementById(`newInput${index}`);
                newRow.push(input.value);
            });

            // הוספה ל-Google Sheets
            gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: spreadsheetId,
                range: sheetName + '!A:A',
                valueInputOption: 'RAW',
                resource: {
                    values: [newRow]
                }
            }).then(() => {
                currentData.push(newRow);
                displayData();
                hideAddForm();
                // ניקוי הטופס
                headers.forEach((header, index) => {
                    document.getElementById(`newInput${index}`).value = '';
                });
                showStatus('רשומה חדשה נוספה בהצלחה', 'success');
            }).catch(error => {
                showStatus('שגיאה בהוספת רשומה: ' + error.message, 'error');
            });
        }

        function deleteRow(rowIndex) {
            if (confirm('האם אתה בטוח שברצונך למחוק את השורה?')) {
                const spreadsheetId = document.getElementById('spreadsheetId').value;
                const sheetName = document.getElementById('sheetName').value;
                
                // מחיקה מ-Google Sheets (שורה ריקה)
                const rowNumber = rowIndex + 2; // +2 כי אנחנו מתחילים משורה 2 (אחרי הכותרות)
                
                gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: 0,
                                    dimension: "ROWS",
                                    startIndex: rowNumber - 1,
                                    endIndex: rowNumber
                                }
                            }
                        }]
                    }
                }).then(() => {
                    currentData.splice(rowIndex, 1);
                    displayData();
                    showStatus('השורה נמחקה בהצלחה', 'success');
                }).catch(error => {
                    showStatus('שגיאה במחיקת השורה: ' + error.message, 'error');
                });
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // טעינה אוטומטית של Google API
        window.onload = function() {
            loadGoogleAPI();
        };
    </script>
</body>
</html>
